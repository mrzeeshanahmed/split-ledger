# Split-Ledger Codebase Memory

## Project Structure

This is a monorepo with backend and frontend workspaces.

```
split-ledger/
├── backend/          # Node.js/Express backend
├── frontend/         # Frontend application
├── docs/            # Documentation
└── docker-compose.yml # PostgreSQL + Redis
```

## Backend Architecture

### Tech Stack
- **Runtime**: Node.js 20+, TypeScript 5.3
- **Framework**: Express 4.18
- **Database**: PostgreSQL 15 with schema-per-tenant multi-tenancy
- **Cache**: Redis 7
- **Auth**: JWT tokens with httpOnly cookies
- **Validation**: Zod
- **Testing**: Vitest, Supertest

### Key Design Patterns

1. **ES Modules**: All files use `.js` extension in imports (e.g., `import { x } from './file.js'`)
2. **Multi-tenancy**: Schema-per-tenant approach - each tenant gets their own PostgreSQL schema
3. **Tenant Context**: Resolved from subdomain or X-Tenant-ID header, attached to request object
4. **Database Pools**: Separate pools for public schema and each tenant schema
5. **Error Handling**: Custom error classes (AppError, ValidationError, UnauthorizedError, etc.)

### Directory Structure

```
backend/
├── src/
│   ├── config/           # Environment configuration (env.ts, validateEnv.ts)
│   ├── db/               # Database clients (index.ts, redis.ts, tenantClient.ts, migrate.ts)
│   ├── errors/           # Custom error classes
│   ├── middleware/       # Express middleware (auth, rateLimiting, tenantContext, validate, etc.)
│   ├── routes/           # API routes (auth, health)
│   ├── services/         # Business logic (auth, tenantProvisioning)
│   ├── types/            # TypeScript type definitions
│   ├── utils/            # Utilities (logger, cookies)
│   └── index.ts          # Application entry point
├── tests/                # Test files (mirrors src structure)
├── migrations/           # SQL migration files
└── package.json
```

## Authentication System

### Token Strategy
- **Access Tokens**: JWT with 15-minute expiry, stored in httpOnly cookies
- **Refresh Tokens**: JWT with 7-day expiry, stored in httpOnly cookies with path restriction
- Both tokens include: userId, tenantId, email, role
- Refresh tokens include unique tokenId for blacklisting

### Security Features
- httpOnly cookies (prevents XSS)
- SameSite=Strict (prevents CSRF)
- Token blacklisting via Redis
- Rate limiting on all auth endpoints
- bcrypt password hashing (12 rounds)
- Email enumeration protection (forgot-password always returns success)

### Auth Endpoints
- `POST /api/auth/register` - Register new user
- `POST /api/auth/login` - Login user
- `POST /api/auth/refresh` - Refresh access token
- `POST /api/auth/logout` - Logout user
- `GET /api/auth/me` - Get current user
- `POST /api/auth/forgot-password` - Request password reset
- `POST /api/auth/reset-password` - Reset password with token

### Auth Middleware
- `requireAuth` - Require authentication
- `requireRole(...roles)` - Require specific roles
- `optionalAuth` - Attempt auth but don't fail

### Rate Limiting
- Auth endpoints: 10 requests per 15 min per IP per tenant
- Password reset: 3 requests per hour per IP per tenant
- API endpoints: 100 requests per 15 min per IP per tenant
- User-specific: 200 requests per 15 min per user

## Database

### Schema-per-Tenant Multi-Tenancy
- Public schema contains `tenants` table
- Each tenant has their own schema: `tenant_<uuid_without_dashes>`
- User tables are in tenant schemas
- Template schema: `tenant_template` for cloning

### Migrations
- Located in `backend/migrations/`
- Run with: `npm run migrate:up` / `npm run migrate:down`
- Naming convention: `###_description.sql`

## Environment Variables

Required environment variables (see `.env.example`):
- `NODE_ENV`, `PORT`
- `DATABASE_URL` or individual DB config
- `REDIS_URL` or individual Redis config
- `JWT_SECRET`, `JWT_EXPIRES_IN`, `REFRESH_TOKEN_SECRET`, `REFRESH_TOKEN_EXPIRES_IN`
- `COOKIE_SECRET`, `COOKIE_DOMAIN`
- `STRIPE_SECRET_KEY`, `STRIPE_PUBLISHABLE_KEY`, `STRIPE_WEBHOOK_SECRET`
- `FRONTEND_URL`, `ALLOWED_ORIGINS`

## Development Workflow

### Running the Backend
```bash
cd backend
npm install
npm run dev          # Start dev server with hot reload
npm run build        # Build TypeScript to JavaScript
npm run start        # Start production server
npm test             # Run all tests
npm test:watch       # Run tests in watch mode
npm run lint         # Run ESLint
npm run typecheck    # Run TypeScript type checking
```

### Running Tests
- Tests are in `backend/tests/` directory
- Structure mirrors `backend/src/`
- Use Vitest as test runner
- Use Supertest for HTTP endpoint testing

### Database Operations
```bash
npm run migrate:up       # Run pending migrations
npm run migrate:down     # Rollback last migration
npm run migrate:create   # Create new migration file
```

## Code Style Preferences

1. **File Extensions**: Always use `.js` extension in imports for ES modules
2. **Error Handling**: Use custom error classes from `src/errors/index.js`
3. **Logging**: Use Winston logger from `src/utils/logger.js`
4. **Validation**: Use Zod schemas in `src/validation/`
5. **Tenant Isolation**: Always use `tenantDb` for tenant-scoped operations
6. **Type Safety**: All files use TypeScript strict mode

## Important Notes

1. **Tenant Context**: All API routes (except `/health`, `/ready`) require tenant context
   - Tenant can be provided via: subdomain, X-Tenant-ID header, or X-Tenant-Subdomain header
   - Middleware attaches `req.tenantId`, `req.tenantSchema`, `req.tenant` to request

2. **Database Queries**:
   - Use `query()` for public schema queries
   - Use `tenantDb.query(tenantSchema, ...)` for tenant queries
   - Use `transaction()` for public schema transactions
   - Use `tenantDb.transaction(tenantSchema, ...)` for tenant transactions

3. **Error Responses**:
   - All errors return JSON format: `{ error: { code, message, details? } }`
   - Custom error codes: VALIDATION_ERROR, UNAUTHORIZED, FORBIDDEN, NOT_FOUND, CONFLICT, TOO_MANY_REQUESTS

4. **Logging**:
   - Use structured logging with context: `logger.info({ message, userId, tenantId })`
   - Production logs are JSON format
   - Development logs are pretty-printed

## Architecture Decisions

See `docs/architecture-decisions.md` for detailed ADRs:
- ADR-001: Multi-Tenancy Schema-per-Tenant
- ADR-002: Payment Abstraction IPaymentProvider
- ADR-003: Authentication Strategy
- ADR-004: API Key Security

## Recent Implementations

### ZEE-13: API Key System (Completed)
- Secure API key generation with 256-bit entropy (crypto.randomBytes(32))
- SHA-256 hashing with timing-safe comparison (prevents timing attacks)
- Key format: `sk_live_<64 hex chars>` or `sk_test_<64 hex chars>`
- Only hash and 8-char prefix stored, raw key shown only once at creation
- Three scopes: `read`, `write`, `admin`
- Per-key rate limiting with Redis sliding window algorithm
  - Per-minute limit (default: 60 requests)
  - Per-day limit (default: 1000 requests)
  - Rate limit headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset
  - Fails open if Redis unavailable
- API key usage tracking in database (endpoint, method, status, response time, IP, user agent)
- API key lifecycle: create, verify, revoke, delete
- Middleware: requireApiKey, requireScope, optionalApiKeyAuth, apiKeyRateLimiter, apiKeyUsageTracker
- Validation schemas for all API key operations
- Stored in tenant schema (tenant_template.api_keys) following ADR-001

**Important:**
- Existing tenants need api_keys and api_key_usage tables added to their schemas
- Migration 004 (api_keys) and 005 (api_key_usage) are in tenant_template, not public schema

### ZEE-11: Authentication System (Completed)
- JWT auth service with token generation/verification
- Auth middleware (requireAuth, requireRole, optionalAuth)
- All auth routes (register, login, logout, refresh, forgot-password, reset-password, me)
- Rate limiting on auth endpoints
- Cookie utilities for secure token storage
- Comprehensive test coverage
- Authentication documentation

### Previous Work
- ZEE-5: Multi-tenant infrastructure
- ZEE-6: Payment abstraction
- ZEE-7: Database infrastructure
- ZEE-9: Tenant provisioning service
- ZEE-10: Tenant context middleware
